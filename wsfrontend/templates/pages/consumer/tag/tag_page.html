{% extends "base_templates/tag_base.html" %}  {# base_templates/page_base.html extends base_templates/base.html #}

{% block tagpagescripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.3/moment.js"></script>

<script type="text/javascript">
  var temp = {{latestsample.temp}};
  var rh = {{latestsample.rh}};
  var latest_timestamp = '{{latestsample.timestamp}}' + 'Z';
  var latest_date = new Date(latest_timestamp);

  function getLatestDateStrings() {
    var year = latest_date.getFullYear();
    var month = latest_date.getMonth() + 1;
    var day = latest_date.getDate();

    return {
      year: String(year),
      month: String(month),
      day: String(day)
    }
  }

  function makeCalUrl(sensor, range) {
    var latest = getLatestDateStrings();
    var date_now  = new Date();
    var tzoffsetmins = date_now.getTimezoneOffset()*-1;
    return '{{ url_for('calview.index', serial=tag.serial) }}' + range +'/'+ sensor +'/'+ latest.year +'/'+ latest.month +'/' + latest.day;
  }

  function makeWrapperAnchor(sensor, tileid, range) {
    var sensorurl = makeCalUrl(sensor, range);
    var sensortile = document.getElementById(tileid);
    sensortile.getElementsByTagName('a')[0].setAttribute('href', sensorurl);

  }


  function initialise() {
    var range = 'day';

    var tempurl = makeWrapperAnchor('temp', 'temptile', range);
    var rhurl = makeWrapperAnchor('rh', 'rhtile', range);

    var herosub = document.getElementById('lastscan');
    var subtextnode = herosub.getElementsByTagName("p")[0];
    subtextnode.append(moment(latest_date).format('HH:mm on MMMM Do YYYY UTCZZ'));
  }

  window.addEventListener('load', initialise);
</script>
{% endblock %}

{% block main %}
<section class="section">
    <div class="container">
      <div id="lastscan"><p>Last scan at </p></div>
    </div>
</section>
<section class="section">
  <div class="container">
    <div class="tile is-ancestor">
      <div class="tile is-6 is-vertical is-parent">


        <div class="tile is-child box" id="temptile">
            <a href="#">
                <span class="icon is-large temperature is-pulled-right">
                <i class="fas fa-thermometer-half fa-3x"></i>
                </span>
                <p class="title">Temperature</p>
                <p class="subtitle">{{ latestsample.temp|round(2) }} Â°C</p>
            </a>
        </div>

        <div class="tile is-child box" id="rhtile">
            <a href="#">
                <span class="icon is-large rh is-pulled-right">
                  <i class="fas fa-tint fa-3x"></i>
                </span>
                <p class="title">Relative Humidity</p>
                <p class="subtitle">{{ latestsample.rh|round(2) }} %</p>
            </a>
        </div>
      </div>


      <div class="tile is-6 is-vertical is-parent">
        <div class="tile is-child box">
          <a href="{{ url_for('tagview.battery', serial=tag.serial) }}">
            <span class="icon is-large battery is-pulled-right">
              <i class="fas fa-battery-full fa-3x"></i>
            </span>
            <p class="title">Battery</p>
            <p class="subtitle">{{ latestcapture.batvoltagemv|int() }} mV</p>
          </a>
        </div>

        <div class="tile is-child box">
          <a href="{{ url_for('tagview.confignfc', serial=tag.serial) }}">
          <span class="icon is-large is-pulled-right">
              <i class="fas fa-cog fa-3x"></i>
            </span>
            <p class="title">Configure</p>
            <p class="subtitle">WebNFC</p>
          </a>
        </div>
      </div>

    </div>
</div>
</section>


{% endblock %}
